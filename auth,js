// === AWS Cognito Config ===
const cognitoDomain = "https://ap-south-1yzdd1yqun.auth.ap-south-1.amazoncognito.com";
const clientId = "4jeul47opmuiuo5o4vipii9hdf";
const redirectUri = "https://sahilo1.vercel.app/index.html";
const logoutRedirectUri = "https://sahilo1.vercel.app/index.html";

// Login URL
const loginUrl =
  `${cognitoDomain}/login?client_id=${clientId}` +
  `&response_type=token&scope=openid+email+profile&redirect_uri=${redirectUri}`;

// Logout URL
const logoutUrl =
  `${cognitoDomain}/logout?client_id=${clientId}` +
  `&logout_uri=${logoutRedirectUri}`;


// === PAGE LOAD ===
document.addEventListener("DOMContentLoaded", () => {
  console.log("Auth JS Loaded Successfully");

  protectCartIcon();            // Protect cart
  protectAddToCartButtons();    // Protect add-to-cart buttons
  handleRedirect();             // Handle Cognito redirect
  updateUI();                   // Update Login/Logout buttons
});


// === HANDLE REDIRECT (After Login) ===
function handleRedirect() {
  const hash = window.location.hash;

  if (!hash.includes("id_token")) return;

  const params = new URLSearchParams(hash.substring(1)); // remove '#'

  const idToken = params.get("id_token");
  const accessToken = params.get("access_token");

  if (idToken) {
    localStorage.setItem("id_token", idToken);
    localStorage.setItem("access_token", accessToken);

    window.location.hash = ""; // clean URL
  }
}


// === PROTECT CART ICON ===
function protectCartIcon() {
  const cartLink = document.getElementById("cartLink");
  if (!cartLink) return;

  cartLink.onclick = () => {
    const idToken = localStorage.getItem("id_token");

    if (!idToken) {
      alert("You must be logged in to view the cart.");
      window.location.href = loginUrl;
    } else {
      window.location.href = "cart.html";
    }
  };
}


// === PROTECT ADD-TO-CART BUTTONS ===
function protectAddToCartButtons() {
  const buttons = document.querySelectorAll(".addToCartBtn");

  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      const idToken = localStorage.getItem("id_token");

      if (!idToken) {
        alert("Please log in to add items.");
        window.location.href = loginUrl;
        return;
      }

      const id = btn.dataset.id;
      addToCartFromCard(id);
    });
  });
}


// === UPDATE LOGIN/LOGOUT UI ===
function updateUI() {
  const idToken = localStorage.getItem("id_token");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const userDisplay = document.getElementById("userDisplay");

  if (!loginBtn || !logoutBtn) return;

  if (idToken) {
    console.log("User Logged In");

    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";
    userDisplay.textContent = "Logged In âœ”";

  } else {
    console.log("User Logged Out");

    loginBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
    userDisplay.textContent = "";
  }

  // This ensures protection checks re-run after UI update
  protectCartIcon();
  protectAddToCartButtons();
}


// === LOGOUT HANDLER ===
document.addEventListener("click", (e) => {
  if (e.target.id === "logoutBtn") {
    localStorage.clear();
    window.location.href = logoutUrl;
  }
});
